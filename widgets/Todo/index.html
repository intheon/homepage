<div class='ui medium form'>
	<div class='fields'>
		<div class='field' class='ui two stackable'>
			<input placeholder='Add new' type='text' id='todoInput' class="in-form">
		</div>
		<div class='scrollable'>
			<div id='outstandingTodos' class='todo-list ui divided very relaxed list'>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

	var Todo = {

	isSubmitShown: false,
	numTodos: 0,

	init: function(todos)
	{
		// so users can add new stuff
		Todo.createFormListeners();

		// so users can see their existing stuff
		Todo.parseExisting(todos);

	},

	createFormListeners: function()
	{
		// makes the form submit button look pretty
		Todo.makeNewTodoFieldClickable();
	},

	makeNewTodoFieldClickable: function()
	{
		$(".in-form").click(function(){

			Todo.listenForKeyboard();

		});
	},

	listenForKeyboard: function()
	{
		$("#todoInput").unbind("keyup").keyup(function(event){

			var who = "#todoInput";
			// grab the current val
			var val = $(who).val();

			// show/hide submit
			if (val.length === 1) Todo.showSubmit(who);
			else if (val.length === 0) Todo.hideSubmit();

		});
	},


	showSubmit: function(who)
	{
		if (!Todo.isSubmitShown)
		{
			var submitButton = "<div class='in-form-submit'>Submit</div>";

			$(submitButton).hide().appendTo($(who).parent()).fadeIn().addClass("nudge");

			$(".in-form-submit").click(function(){
				Todo.generateTodo();
				Todo.hideSubmit();
			});

			$("#todoInput").keypress(function(event){
				// add event listener so you can hit enter
				if (event.keyCode == 13) 
				{
					if (!$("#todoInput").val()) return false;
					else
					{
						Todo.generateTodo();
						Todo.hideSubmit();
					}
				}
			});
		}
		Todo.isSubmitShown = true;

	},

	hideSubmit: function()
	{
		if (Todo.isSubmitShown)
		{
			Todo.isSubmitShown = false;
			$(".in-form-submit").removeClass("nudge");
			Todo.resetFormState();
			Todo.listenForKeyboard();
		}
	},

	resetFormState: function()
	{
		// reset the forms and listeners to their initial state
		$("#todoInput").val("");
		$("#todoInput").unbind("keyup")
	},

	generateTodo: function()
	{
		var tString = $("#todoInput").val();
		var timeStamp = Todo.generateTimestamp();
		var timeStampTrimmed = timeStamp.substr(0, timeStamp.length - 29);

		// add it immediately client side
		Todo.addToFrontEnd(tString, timeStampTrimmed);

		// add it in the background so it persists upon browser refresh
		Todo.addToBackEnd(tString, timeStamp);

	},

	generateTimestamp: function()
	{
		return new Date().toString();
	},

	addToFrontEnd: function(content, timestamp, maxTodos)
	{

		Todo.numTodos++;

		var todoContent = "<div class='item'><i class='thumb tack icon'></i><div class='content'><div class='header'>"+content+"</div><div class='smallText'>"+timestamp+"</div></div></div>";

		$(todoContent).appendTo($("#outstandingTodos"));

		if (Todo.numTodos == maxTodos) Todo.makeResponsive();


		/*
		var rand = Math.floor(Math.random() * 4) + 1;
		var rand2 = Math.floor(Math.random() * 3) + 1;

		var noteColour = "note-colour-" + rand;
		var noteRotate = "note-rotation-" + rand2;
		var pinPosition = "pin-location-" + rand2;

		// create a sticky note
		var content = "<div class='todo-list-item note-base "+noteColour+" "+noteRotate+"'><i class='pin "+pinPosition+"'></i><div class='todo-content'>"+ content +"</div><div class='todo-timestamp'>"+ timestamp +"</div><div class='note-delete'>delete</div></div>";

		// add it to the dom
		$(content).hide().appendTo($("#outstandingTodos")).fadeIn();

		Todo.numTodos++;

		// once the max has been reached, ensure panels are made
		if (Todo.numTodos == maxTodos) Todo.makeResponsive();
		*/

	},

	makeResponsive: function()
	{
		var height = window.innerHeight;
			height += -20;

		$(".scrollable").css("height", height);

		$("#outstandingTodos")
			.mouseenter(function(){
				UserManager.applyScrollify("destroy");
			})
			.mouseleave(function(){
				UserManager.applyScrollify();
			});


	},

	addToBackEnd: function(content, timestamp)
	{
		// to update a state we need the stateId, userId, and widgetId to ensure we've got the right one

		// primary key of state we need to update in db
		var stateId = UserManager.returnStatePrimary("todo");

		// the current data
		var stateData = UserManager.returnStateData("todo");

		// a new block with the new data appended
		var latestJson = Todo.appendNewTodo(content, timestamp, stateData);

		// payload is the standard phrase
		var payload = latestJson;

		// authentication
		var auth = UserManager.usersAuth();

		UserManager.ajaxHandler("PUT", "rest-backend/api/state/" + stateId, payload, Todo.updateState, auth.cookieString);

	},

	updateState: function(message)
	{
		console.log(message);
	},

	appendNewTodo: function(newContent, newTimestamp, existingContent)
	{
		var latest = existingContent.substr(0, existingContent.length - 2);
			latest = latest + ',{"itemName":"' + newContent + '", "date":"'+ newTimestamp +'"}]}';

		return latest;
	},

	parseExisting: function(todos)
	{
		// todos are a massive string with all their metadata
		var tData = JSON.parse(todos);

		// loop through each todo in todoData and cram that through the front end function
		var tItems = JSON.parse(tData.jsonData);

		// our integer quantity of xisting todos
		var maxTodos = tItems.items.length;

		// create a nice stat for it
		UserManager.createStatistic("Tasks", maxTodos);

		for (singleItem in tItems)
		{
			for (individuals in tItems[singleItem])
			{
				// make a little easier to read
				var content = tItems[singleItem][individuals].itemName;
				var timestamp = tItems[singleItem][individuals].date;
					timestamp = timestamp.substr(0, timestamp.length - 29);

				// go!
				Todo.addToFrontEnd(content, timestamp, maxTodos);
			}

		}

	}

};
</script>

