<div class="calendar-body ui stackable grid"></div>
<div class="calendar-messages"></div>

<script type="text/javascript">
	var Calendar = {

		// super useful global metadata will be used throughout
		today: moment(),
		todaysDayAsInt: parseInt(moment().format("D")),
		thisMonthAsInt: parseInt(moment().format("M")),
		thisYearAsInt: parseInt(moment().format("YYYY")),
		thisMonthAsObj: moment(this.thisMonthAsInt, "M"),
		thisMonthAsPhrase: moment().format("MMMM"),
		thisMonthAsPhraseLower: moment().format("MMMM").toLowerCase(),
		quantToDisplay: [],


		init: function(existingData)
		{

			// self execute
			Calendar.quantToDisplay = (function()
			{
				var array = [
					Calendar.buildAMoment(-2),
					Calendar.buildAMoment(-1),
					Calendar.buildAMoment(+0),
					Calendar.buildAMoment(+1),
					Calendar.buildAMoment(+2),
					Calendar.buildAMoment(+3),
					Calendar.buildAMoment(+4),
					Calendar.buildAMoment(+5)
				];
				return array;
			})();


			Calendar.generateCalendar(Calendar.quantToDisplay, existingData);

		},

		buildAMoment: function(offset)
		{
			return moment().month(parseInt(moment().format("M") - 1) + offset);
		},

		generateCalendar: function(months, existingData)
		{
			Calendar.renderCells(months, existingData);

		},

		renderCells: function(months, existingData)
		{
			$.each(months, function(month)
			{

				var inMonth = months[month].daysInMonth();
				var nameMonthFull = months[month].format("MMMM");
				var nameMonth = months[month].format("MMMM").toLowerCase();

				$(".calendar-body").append("<div class='ui three wide column month-metadata' id='"+nameMonth+"-metadata'><h3 class='month-name ui top attached header'>" + nameMonthFull + "</h3><div class='ui attached segment stackable'><div class='month-starting-wage ui tiny statistic'></div></div></div><div class='month-section ui thirteen wide column ' id='month-" + nameMonth + "'></div>")

				for (var i = 1; i <= inMonth; i++)
				{
					$("#month-" + nameMonth).append("<div class='calendar-item calendar-item-" + i + "'>\
					<div class='ui dropdown z-top'>\
						<i class='dropdown icon'></i>\
						<div class='menu'>\
							<div class='item show-modal' id='stats-modal'>\
								<i class='tasks icon'></i>Current\
							</div>\
							<div class='item show-modal' id='purchase-modal'>\
								<i class='money icon'></i>New Purchase\
							</div>\
							<div class='item show-modal' id='diary-modal'>\
								<i class='calendar icon'></i>New Diary entry\
							</div>\
						</div>\
					</div>\
					<div class='date-number'>" + i + "</div>\
					<div class='day-label'></div>\
					<div class='day-summary'><div class='event-summary'></div><div class='spend-summary'></div></div>\
					<div class='day-details'></div>\
				</div>");
				}
			});


			Calendar.attachListeners();
			Calendar.makeResponsive();
			Calendar.parseUserData(existingData);

		},

		attachListeners: function()
		{
			// register dropdown handler
			$('.ui.dropdown').dropdown();

			// allow modal to occur

			$(".dropdown .item").click(function(event){
				Calendar.presentPopupModal(event);
			});
		},

		makeResponsive: function()
		{
			var height = window.innerHeight;

			$(".calendar-body").css("height", height);

			$(".calendar-body")
				.mouseenter(function()
				{
					UserManager.applyScrollify("destroy");
				})
				.mouseleave(function()
				{
					UserManager.applyScrollify();
				});


			// disabled for now, little buggy
			/*
			$('.calendar-body').animate(
			{
				scrollTop: $("#month-" + Calendar.thisMonthAsPhraseLower).offset().top - 945
			}, 4000);
			*/

		},

		parseUserData: function(existingData)
		{
			var fullProfile = JSON.parse(existingData);
			var widgetData = JSON.parse(fullProfile.jsonData);

			if (widgetData.items.length === 0) Calendar.askForPayday();
			else Calendar.addExistingCalItems(existingData);
		},

		addExistingCalItems: function(existingData)
		{
			var entireData = JSON.parse(existingData);
			var metadata = JSON.parse(entireData.jsonData);
			var calendarProfile = metadata.items[0].profile;
			var calendarItems = metadata.items[1].calendar;

			// first, let's add in the paydays
			Calendar.addInPaydays(calendarProfile);

			// add in our starting wage
			Calendar.addInStartingWage(calendarProfile.payAmount);

			// label todays date
			Calendar.labelTodaysDate();

			// now, the individual calendar items
			//if (!calendarItems) console.log("empty");
			//else console.log("not empty");
		},

		labelTodaysDate: function()
		{
			$("#month-" + Calendar.thisMonthAsPhraseLower + " .calendar-item-" + Calendar.todaysDayAsInt).addClass("calendar-item-today");
		},

		askForPayday: function()
		{
			// hide the calendar
			$(".calendar-body").hide();

			// create an initial overlay which forces the user to input some data on their payday
			$(".calendar-messages").append("<div class='overlay payday-overlay'>\
				<div class='payday-form ui container'>\
					<header>Please enter your payday to continue</header>\
					<div class='ui buttons'>\
						<button class='ui button payday-frequency' id='weekly-pay'>Weekly</button>\
						<div class='or'></div>\
						<button class='ui button payday-frequency' id='monthly-pay'>Monthly</button>\
					</div>\
					<div class='payday-options'></div>\
				</div>\
			</div>");

			// add listeners to branch off and show the sub-forms for weekly, and monthly

			$(".payday-frequency").click(function(e)
			{
				var freq = e.currentTarget.id;
				if (freq == "weekly-pay") Calendar.weeklyPay();
				else if (freq == "monthly-pay") Calendar.monthlyPay();
			});
		},

		askForWage: function(which)
		{
			Calendar.clearForm(".payday-form");

			$(".payday-form").html("<div class='ui fluid form'>\
				<div class='field'>\
					<input type='text' placeholder='How much did you get paid on this day?' id='payday-wage-amount'>\
				</div>\
				<div class='ui button' id='submit-wages'>Submit</div>\
				<div class='error' id='wage-error-message'></div>\
			</div>");


			$("#submit-wages").click(function()
			{
				var pay = $("#payday-wage-amount").val();

				if (!pay || isNaN(pay) || pay < 0 || pay > 10000)
					$("#wage-error-message").html("This is a bad value. Only integers please!");
				else
					$("#wage-error-message").html("");
					$("#payday-wage-amount").val("");

					var freq = which.split("-")[0];
					var multi = which.split("-")[1];

					var payload = {
						payFreq: freq,
						payDay: multi,
						payAmount: pay
					}

					Calendar.updateUsersState(payload);
			});
		},

		weeklyPay: function()
		{
			Calendar.clearForm(".payday-options");
			$(".payday-options").append("<header>On which day of the week do you get paid?</header>\
				<div class='ui buttons'>\
  				<button class='ui button wage-freq' id='week-1'>Monday</button>\
  				<button class='ui button wage-freq' id='week-2'>Tuesday</button>\
  				<button class='ui button wage-freq' id='week-3'>Wednesday</button>\
  				<button class='ui button wage-freq' id='week-4'>Thursday</button>\
  				<button class='ui button wage-freq' id='week-5'>Friday</button>\
  				<button class='ui button wage-freq' id='week-6'>Saturday</button>\
  				<button class='ui button wage-freq' id='week-7'>Sunday</button>\
			</div>");

			$(".wage-freq").click(function(e)
			{
				var which = e.currentTarget.id;
				Calendar.askForWage(which);
			});
		},

		monthlyPay: function()
		{
			Calendar.clearForm(".payday-options");
			var formHTML = $("<div class='ui buttons ui container payday-form'></div>");

			for (i = 0; i <= 31; i++) $(formHTML).append("<div class='ui button wage-freq' id='month-" + i + "'>" + i + "</div>");

			$(".payday-options").prepend("<header>On which day of the month do you get paid?</header>");
			$(".payday-options").append(formHTML);

			$(".wage-freq").click(function(e)
			{
				var which = e.currentTarget.id;
				Calendar.askForWage(which);
			});
		},

		addInPaydays: function(paydayMeta)
		{
			if (paydayMeta.payFreq == "month")
			{
				var day = paydayMeta.payDay;
				var id = "calendar-item-" + day;

				$("." + id).append("<div class='ui mini blue basic inverted label  '>Payday!</div>");
			}		
			else if (paydayMeta.payFreq == "week")
			{
				console.log("load weeks");
			}
		},

		addInStartingWage: function(startingWageData)
		{
			$(".month-starting-wage").html("<div class='value'>£"+startingWageData+"</div><div class='label'>Remaining</div></div>");
			UserManager.createStatistic("Money", startingWageData);
		},

		clearForm: function(what)
		{
			if (!$(what).html()) return false;
			else $(what).html("");
		},

		updateUsersState: function(payload)
		{
			var json = {
				"items": [
				{
					"profile": payload
				},
				{
					"calendar": null
				}]
			}

			var stateId = UserManager.returnStatePrimary("calendar");

			var asString = JSON.stringify(json);

			// authentication
			var auth = UserManager.usersAuth();

			UserManager.ajaxHandler("PUT", "rest-backend/api/state/" + stateId, asString, Calendar.dismissModal, auth.cookieString);
		},

		presentPopupModal: function(event)
		{
			var type = event.currentTarget.id;
			var content, title = "";

			DisplayManager.createBlankModal();

			switch (type)
			{
				case "purchase-modal":
					title = "Add Spend";
					content = "<div id='spending-field' class='modal-form-wrapper'>\
						<div class='ui segment'>\
							<div class='ui right labeled fluid input'>\
								<div class='ui label'>£</div>\
								<input type='text' placeholder='Amount' id='spending-item-desc'>\
								<div class='ui basic label'>.00</div>\
							</div>\
							<br />\
							<div class='ui form'>\
								<div class='two fields'>\
									<div class='field'>\
										<label>Description</label>\
										<div class='ui left icon input'>\
											<input type='text' placeholder='Description' id='spending-item-name'>\
											<i class='tags icon'></i>\
										</div>\
									</div>\
									<div class='field'>\
										<label>Tags</label>\
										<div class='ui multiple selection dropdown'>\
											<input name='all-tags' type='hidden' value=''>\
											<i class='dropdown icon'></i>\
											<div class='default text'>Choose Tag</div>\
											<div class='menu'>\
												<div class='item' data-value='food'>Food</div>\
												<div class='item' data-value='beer'>Beer</div>\
											</div>\
										</div>\
									</div>\
								</div>\
							</div>\
						</div>\
					</div>";
					break;

				case "diary-modal":
					title = "Add Diary";
					content = "<div id='diary-field' class='modal-form-wrapper'><div class='field modal-field'><label>Event name</label><input type='text' placeholder='Name' id='diary-item-name' class='modal-input-class'></div><div class='field modal-field'><label>Event information</label><input type='text' placeholder='Description' id='diary-item-desc' class='modal-input-class'></div></div>";
					break;

				case "stats-modal":
					title = "Overview for day";
					content = "<div id='stats-overview>Some useful stats here</div>";
					break;

				default:
					console.log("lol b0rked");
					break;
		};

		$(".ui.modal .modal-header").html(title);
		$(".ui.modal .modal-content .fields").html(content);
		$(".ui.modal .actions .button").click(function(event)
		{
			console.log("you are here");
			/*
			var type = event.currentTarget.id;

			if (type == "add-item-modal")
			{

				var id = $(".modal-form-wrapper")[0].id;
				var split = id.split("-");

				// TODO VALIDATION
				var name = $("#" + split[0] + "-item-name").val();
				var detail = $("#" + split[0] + "-item-desc").val();

				payload.name = name;
				payload.detail = detail;
			}

			Calendar.setUsersEvents(payload);
			*/
			// remove from dom to stop duplicate modals from appearing.
			Calendar.removeModalFromDom();
			
		});

		$("#cancel-modal").click(function()
		{
			Calendar.removeModalFromDom();
		});

		/*

		$("#modal .button").click(function()
		{
			console.log("second one");
			Calendar.removeModalFromDom();
		});
*/


		$('.ui.modal').modal('show');

		setTimeout(function(){
			console.log("listener created");
			$("ui.multiple.selection.dropdown").dropdown();
		},1000);
		

		$(".benjamin.ui.dropdown").click(function(){
			console.log("yep");
		});




	},

	removeModalFromDom: function()
	{
		$("#modal").fadeOut("slow", function()
		{
			$("#modal").remove();
			$(".ui.dimmer.modals").remove()
		});
	},


	dismissModal: function()
	{
		$(".payday-overlay").fadeOut(function()
		{
			$(this).remove();

			$(".calendar-messages").hide();
			$(".calendar-body").show();
				
		});
	}

}
</script>